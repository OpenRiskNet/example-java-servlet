# Deploy using Keycloak

This recipe describes how to deploy this example servlet to an OpenShift environment that is providing SSO
capabilities using Keycloak (Red Hat SSO).

**NOTE**: this is work in progress - do probably don't want to try this yet.

## Overview

The OpenRiskNet environment is planned to provide SSO capabilites using Keycloak.
So to use this for authentication the Tomcat container needs to be configured with a
valve that performs the authentication. This value recognises that the user is not signed
in and redirects to Keycloak where the user enters their username and password. If successful
the user is redirected back to Tomcat with a JSON Web Token containing the credentials, including
an access token and a list of roles the user has. This time Tomcat accepts the user as being
authorised and passes the request through to the servlet webapp.

To configure this we need to add various things to the Tomcat configuration.

1. The Keycloak adapter jar files that need to go in the $CATALINA_HOME/lib directory
1. Updates to server.xml and context.xml in $CATALINA_HOME/conf
1. Updates to web.xml in $CATALINA_HOME/webapps/ROOT/WEB-INF
1. Add keycloak.json to $CATALINA_HOME/webapps/ROOT/WEB-INF

These files are in the [openshift/keycloak]() directory and will need editing if you are not using
the standard set up which is:

* Base domain name of `os.informaticsmatters.com`
* Keycloak found at `https://secure-sso.os.informaticsmatters.com`
* Keycloak realm of `openrisknet`
* User requires role of `standard-user`

## Docker image

The Dockerfile that builds the image is [Dockerfile-keycloak](). Note: the Dockerfile that is used 
to build the standard version is generated by the gradle build and so is not in git.

To build the image first make sure that the war file is built and then build and push the image:
```
$ ./gradlew war
<snip>
$ docker build -t tdudgeon/hello-example-servlet -f Dockerfile-keycloak .
<snip>
$ docker push tdudgeon/hello-example-servlet
<snip>
```
NOTE: a temporary image name is used for now. This will be changed once the process is complete.

## Prepare OpenShift

Create an OpenShift environment as follows:

1. Create OpenShift nodes according to standard recipes (e.g. [here](https://github.com/OpenRiskNet/home/blob/master/openshift/ansible-simple-one.md)) and set up DNS.
1. Create an openrisknet-infra project
1. Deploy Keycloak to the openrisknet-infra project according to the [standard recipe](https://github.com/OpenRiskNet/home/tree/master/openshift/sso).
1. Deploy the ACME controller to the openrisknet-infra project according to the [standard recipe](https://github.com/OpenRiskNet/home/tree/master/openshift/certificates).
1. Set up permissions as described in the [basic recipe](README.md) to allow containers to be run as a specified user.
1. Create the client configuration in the keycloak realm and add a user with `standard-user` role [TODO - create a template for this]

## Deploy Hello Servlet to OpenShift
 
First create a new project for the app.
```
oc new-project hello-servlet
```

Review the [openshift/keycloak/deploy.yaml]() file with respect to your environment. You will need to specify some paramters when deploying.
Deploy with something like this:
```
oc process -f openshift/keycloak/route.yml -p APPLICATION_DOMAIN=hello.os.informaticsmatters.com | oc create -f -
```
Change the APPLICATION_DOMAIN accordingly to get a suitable host name for your app.

Once deployed the ACME Controller will provide TLS support for the route.
Try to access it and you will see the Keycloak login prompt.


